name: IPTV Playlist Checker
on:
  workflow_dispatch:
    inputs:
      NUM_THREADS:
        description: 'Number of threads to use'
        type: number
        required: true
        default: '4'
      TIMEOUT:
        description: 'Timeout for FFmpeg'
        type: number
        required: true
        default: '25'  
  # schedule:
        # - cron: '0 0 * * *'

jobs:
  check:  
    name: IPTV Playlist Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Delete old workflow run ❌
        uses: Mattraks/delete-workflow-runs@v2.0.6
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 3
          keep_minimum_runs: 4
          delete_workflow_pattern: "IPTV Playlist Checker"
          
      - name: Checkout ♻️
        uses: actions/checkout@v4

      - name: Setup Python 🐍
        uses: actions/setup-python@v5
        with:
          python-version: '3.13' 

      - name: Setup FFMPEG Dependencies 🧑‍🏭
        uses: AnimMouse/setup-ffmpeg@v1

      - name: Install Python Dependencies 🧑‍🏭    
        run: |
            pip install -r .github/pyscripts/requirements.txt
            
      - name: Setup WireGuard Dependencies 🧑‍🏭
        run: |
            sudo apt-get update
            sudo apt-get install resolvconf wireguard
            
      - name: Setup and Connect to VPN 📶🛜
        run: |
            printf '%s' "${{ secrets.WIREGUARDCONFIG }}" | sudo tee /etc/wireguard/wg0.conf > /dev/null
            sudo wg-quick up wg0 > /dev/null

      - name: Check IP Address   
        run: curl ifconfig.me

      - name: Obtain and merge playlists 📥
        working-directory: .github/pyscripts
        run: |
          mkdir playlists
          python mergeplaylists.py playlists/playlist.m3u8 urls.json

      - name: Check playlist 📺 
        working-directory: .github/pyscripts
        run: |
          python iptvcheck.py -p playlists/playlist.m3u8 -s playlists/scrapedstreams.m3u8 -t $NUM_THREADS -ft $TIMEOUT
        env:
          NUM_THREADS: ${{ inputs.NUM_THREADS }}
          TIMEOUT: ${{ inputs.TIMEOUT }} 

      - name: Disconnect from VPN and remove config file 📶🛜
        run: |
            sudo wg-quick down wg0 > /dev/null
            sudo rm -rf /etc/wireguard/wg0.conf > /dev/null

      - name: Remove Files 🗑️
        run: |
            sudo rm -rf .github/pyscripts/playlists/playlist.m3u8        

      - name: Check Files and Folders and Subfolders 📂
        run: |
          ls -lahR
          
      - name: Commit and push changes
        run: |
          git diff
          git add .github/pyscripts/playlists/
          git config --global user.email "184839081+HaoTianming@users.noreply.github.com"
          git config --global user.name "HaoTianming"
          git commit -am "Scrape Public IPTV Sources" || exit 0
          git pull --rebase origin main
          git push
